# Cloud-init for ${project_name} ${environment} server
# 1. íŒ¨í‚¤ì§€ ê´€ë¦¬ ì„¤ì •
package_update: true
package_upgrade: true

# 2. íŒ¨í‚¤ì§€ ëª©ë¡
packages:
  - docker.io
  - git
  - curl
  - wget
  - unzip
  - htop
  - vim
  - python3
  - python3-pip
  - python3-venv
  - certbot

# 3. íŒŒì¼ ìƒì„±
write_files:
  # Docker ë¡œê·¸ì¸ í—¬í¼ ìŠ¤í¬ë¦½íŠ¸
  - path: /home/ubuntu/docker-login.sh
    permissions: '0755'
    owner: root:root
    content: |
      #!/bin/bash
      # Oracle Container Registry ë¡œê·¸ì¸ ìŠ¤í¬ë¦½íŠ¸
      set -e
      if [ "$#" -ne 4 ]; then
          echo "Usage: $0 <region> <tenancy-namespace> <username> <auth-token>"
          echo "Example: $0 ap-chuncheon-1 mytenancy myuser mytoken"
          exit 1
      fi
      
      REGION=$1
      TENANCY_NAMESPACE=$2
      USERNAME=$3
      AUTH_TOKEN=$4
      
      echo "Logging into Oracle Container Registry..."
      echo "$AUTH_TOKEN" | docker login $REGION.ocir.io -u $TENANCY_NAMESPACE/$USERNAME --password-stdin
      
      if [ $? -eq 0 ]; then
          echo "âœ… Successfully logged into $REGION.ocir.io"
      else
          echo "âŒ Failed to log into Oracle Container Registry"
          exit 1
      fi

  # Let's Encrypt ì¸ì¦ì„œ ìë™ ë°œê¸‰ ë° ê°±ì‹  ìŠ¤í¬ë¦½íŠ¸
  - path: /usr/local/sbin/setup-letsencrypt.sh
    permissions: '0755'
    owner: root:root
    content: |
      #!/bin/bash
      set -e
      
      DOMAIN="www.junhyung.xyz"
      CERT_DIR="/opt/letsencrypt"
      EMAIL="admin@junhyung.xyz"
      
      echo "--- ğŸ“œ Let's Encrypt ì¸ì¦ì„œ ì„¤ì • ì‹œì‘ ---"
      
      # ì¸ì¦ì„œ ì €ì¥ ë””ë ‰í„°ë¦¬ ìƒì„±
      mkdir -p $CERT_DIR
      
      # ë„ë©”ì¸ì´ ì´ ì„œë²„ë¥¼ ê°€ë¦¬í‚¤ëŠ”ì§€ í™•ì¸
      echo "ğŸ” ë„ë©”ì¸ DNS í™•ì¸ ì¤‘..."
      CURRENT_IP=$(curl -s ifconfig.me || curl -s ipinfo.io/ip)
      DOMAIN_IP=$(dig +short $DOMAIN | tail -n1)
      
      echo "í˜„ì¬ ì„œë²„ IP: $CURRENT_IP"
      echo "ë„ë©”ì¸($DOMAIN) IP: $DOMAIN_IP"
      
      if [ "$CURRENT_IP" != "$DOMAIN_IP" ]; then
          echo "âš ï¸ ê²½ê³ : ë„ë©”ì¸ì´ ì•„ì§ ì´ ì„œë²„ë¥¼ ê°€ë¦¬í‚¤ì§€ ì•ŠìŠµë‹ˆë‹¤."
          echo "DNS ì „íŒŒë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘... (ìµœëŒ€ 10ë¶„)"
          for i in {1..60}; do
              sleep 10
              DOMAIN_IP=$(dig +short $DOMAIN | tail -n1)
              if [ "$CURRENT_IP" = "$DOMAIN_IP" ]; then
                  echo "âœ… DNS ì „íŒŒ ì™„ë£Œ!"
                  break
              fi
              echo "ëŒ€ê¸° ì¤‘... ($i/60)"
          done
      fi
      
      # Let's Encrypt ì¸ì¦ì„œ ë°œê¸‰ (ì›¹ë£¨íŠ¸ ë°©ì‹ ì‚¬ìš©)
      echo "ğŸ”’ Let's Encrypt ì¸ì¦ì„œ ë°œê¸‰ ì¤‘..."
      certbot certonly \
          --webroot \
          --webroot-path /opt/chat-service/webroot \
          --non-interactive \
          --agree-tos \
          --email $EMAIL \
          --domains $DOMAIN \
          --no-eff-email
      
      # ë°œê¸‰ëœ ì¸ì¦ì„œë¥¼ /opt/letsencryptë¡œ ë³µì‚¬
      if [ -d "/etc/letsencrypt/live/$DOMAIN" ]; then
          echo "ğŸ“‹ ì¸ì¦ì„œ ë³µì‚¬ ì¤‘..."
          cp "/etc/letsencrypt/live/$DOMAIN/fullchain.pem" "$CERT_DIR/cert.pem"
          cp "/etc/letsencrypt/live/$DOMAIN/privkey.pem" "$CERT_DIR/privkey.pem"
          cp "/etc/letsencrypt/live/$DOMAIN/chain.pem" "$CERT_DIR/chain.pem" 2>/dev/null || echo "ì²´ì¸ íŒŒì¼ ì—†ìŒ"
          
          # ê¶Œí•œ ì„¤ì •
          chown -R ubuntu:ubuntu $CERT_DIR
          chmod 600 $CERT_DIR/privkey.pem
          chmod 644 $CERT_DIR/cert.pem $CERT_DIR/chain.pem 2>/dev/null || true
          
          echo "âœ… ì¸ì¦ì„œê°€ $CERT_DIR ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."
          
          # ì¸ì¦ì„œ ì •ë³´ ì¶œë ¥
          echo "ğŸ“Š ì¸ì¦ì„œ ì •ë³´:"
          openssl x509 -in $CERT_DIR/cert.pem -text -noout | grep -E "(Subject:|Not Before|Not After)"
      else
          echo "âŒ ì¸ì¦ì„œ ë°œê¸‰ ì‹¤íŒ¨"
          exit 1
      fi
      
      # ìë™ ê°±ì‹  ì„¤ì • (crontab)
      echo "â° ìë™ ê°±ì‹  ì„¤ì • ì¤‘..."
      (crontab -l 2>/dev/null; echo "0 2 * * 0 /usr/bin/certbot renew --quiet --webroot --webroot-path /opt/chat-service/webroot && /usr/local/sbin/update-lb-cert.sh") | crontab -
      
      echo "ğŸ‰ Let's Encrypt ì„¤ì • ì™„ë£Œ!"

  # ë¡œë“œ ë°¸ëŸ°ì„œ ì¸ì¦ì„œ ì—…ë°ì´íŠ¸ ìŠ¤í¬ë¦½íŠ¸
  - path: /usr/local/sbin/update-lb-cert.sh
    permissions: '0755'
    owner: root:root
    content: |
      #!/bin/bash
      set -e
      
      DOMAIN="www.junhyung.xyz"
      CERT_DIR="/opt/letsencrypt"
      
      echo "--- ğŸ”„ ë¡œë“œ ë°¸ëŸ°ì„œ ì¸ì¦ì„œ ì—…ë°ì´íŠ¸ ---"
      
      # ìƒˆë¡œìš´ ì¸ì¦ì„œê°€ ìˆëŠ”ì§€ í™•ì¸
      if [ -f "/etc/letsencrypt/live/$DOMAIN/fullchain.pem" ]; then
          # ì¸ì¦ì„œ ë³µì‚¬
          cp "/etc/letsencrypt/live/$DOMAIN/fullchain.pem" "$CERT_DIR/cert.pem"
          cp "/etc/letsencrypt/live/$DOMAIN/privkey.pem" "$CERT_DIR/privkey.pem"
          cp "/etc/letsencrypt/live/$DOMAIN/chain.pem" "$CERT_DIR/chain.pem" 2>/dev/null || true
          
          # ê¶Œí•œ ì„¤ì •
          chown -R ubuntu:ubuntu $CERT_DIR
          chmod 600 $CERT_DIR/privkey.pem
          chmod 644 $CERT_DIR/cert.pem $CERT_DIR/chain.pem 2>/dev/null || true
          
          echo "âœ… ì¸ì¦ì„œ ì—…ë°ì´íŠ¸ ì™„ë£Œ: $(date)"
          
          # TODO: ì—¬ê¸°ì— OCI CLIë¥¼ ì‚¬ìš©í•´ ë¡œë“œ ë°¸ëŸ°ì„œ ì¸ì¦ì„œë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ë¡œì§ ì¶”ê°€
          # oci lb certificate update --load-balancer-id <LB_ID> --certificate-name junhyung-xyz ...
          
      else
          echo "âŒ ìƒˆë¡œìš´ ì¸ì¦ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
      fi

  # ì¸ìŠ¤í„´ìŠ¤ ì´ˆê¸° ì„¤ì •ì„ ìœ„í•œ í†µí•© ìŠ¤í¬ë¦½íŠ¸
  - path: /usr/local/sbin/initial-setup.sh
    permissions: '0755'
    owner: root:root
    content: |
      #!/bin/bash
      set -e # ì˜¤ë¥˜ ë°œìƒ ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨
      
      echo "--- ğŸ§± ë¸”ë¡ ë³¼ë¥¨ ë§ˆìš´íŠ¸ ì‹œì‘ ---"
      BLOCK_DEVICE="/dev/oracleoci/oraclevdb"
      timeout=300
      while [ $timeout -gt 0 ] && [ ! -b "$BLOCK_DEVICE" ]; do
        echo "Waiting for block volume $BLOCK_DEVICE..."
        sleep 5
        timeout=$((timeout-5))
      done
      
      if [ -b "$BLOCK_DEVICE" ]; then
        if ! blkid "$BLOCK_DEVICE" | grep -q TYPE; then
          echo "Creating filesystem on $BLOCK_DEVICE"
          mkfs.ext4 "$BLOCK_DEVICE"
        fi
        mkdir -p /data
        mount "$BLOCK_DEVICE" /data
        chown ubuntu:ubuntu /data
        UUID=$(blkid -s UUID -o value "$BLOCK_DEVICE")
        if [ -n "$UUID" ] && ! grep -q "$UUID" /etc/fstab; then
          echo "UUID=$UUID /data ext4 defaults,noatime 0 2" >> /etc/fstab
        fi
        echo "âœ… ë¸”ë¡ ë³¼ë¥¨ì´ /data ì— ì„±ê³µì ìœ¼ë¡œ ë§ˆìš´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤."
      else
        echo "âš ï¸ ë¸”ë¡ ë³¼ë¥¨($BLOCK_DEVICE)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
      fi
      
      echo "--- ğŸ’¾ ìŠ¤ì™‘ íŒŒì¼ ì„¤ì • ì‹œì‘ ---"
      if ! swapon --show | grep -q '/swapfile'; then
        fallocate -l 2G /swapfile || dd if=/dev/zero of=/swapfile bs=1M count=2048
        chmod 600 /swapfile
        mkswap /swapfile
        swapon /swapfile
        echo '/swapfile none swap sw 0 0' >> /etc/fstab
        sysctl -w vm.swappiness=10
        echo "vm.swappiness=10" >> /etc/sysctl.conf
        echo "âœ… 2GiB ìŠ¤ì™‘ íŒŒì¼ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤."
      else
        echo "âœ… ìŠ¤ì™‘ íŒŒì¼ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."
      fi
      
      echo "--- âš™ï¸ ì‹œìŠ¤í…œ ì»¤ë„ íŒŒë¼ë¯¸í„° ìµœì í™” ì‹œì‘ ---"
      if ! grep -q "net.core.somaxconn" /etc/sysctl.conf; then
        echo 'net.core.somaxconn = 65535' >> /etc/sysctl.conf
        echo 'net.ipv4.tcp_max_syn_backlog = 65535' >> /etc/sysctl.conf
        sysctl -p
        echo "âœ… ì‹œìŠ¤í…œ ì»¤ë„ íŒŒë¼ë¯¸í„°ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤."
      else
        echo "âœ… ì‹œìŠ¤í…œ ì»¤ë„ íŒŒë¼ë¯¸í„°ê°€ ì´ë¯¸ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
      fi

# 4. ì‹¤í–‰ ëª…ë ¹ì–´
runcmd:
  # Docker ì„¤ì •
  - systemctl enable --now docker
  - usermod -aG docker ubuntu

  # OCI CLI ì„¤ì¹˜
  - pip install oci-cli --break-system-packages

  # Docker Compose ìµœì‹  ë²„ì „ ì„¤ì¹˜
  - |
    set -e
    echo "â¬‡ï¸ Installing latest Docker Compose..."
    DOCKER_PLUGIN_DIR="/usr/local/lib/docker/cli-plugins"
    mkdir -p "$DOCKER_PLUGIN_DIR"
    COMPOSE_URL="https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s | tr '[:upper:]' '[:lower:]')-$(uname -m)"
    curl -SL "$COMPOSE_URL" -o "$DOCKER_PLUGIN_DIR/docker-compose"
    chmod +x "$DOCKER_PLUGIN_DIR/docker-compose"
    echo "âœ… Docker Compose installed: $(docker compose version)"

  # ìƒì„±í•œ í†µí•© ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
  - /usr/local/sbin/initial-setup.sh

  # ì• í”Œë¦¬ì¼€ì´ì…˜ ê¸°ë³¸ ë””ë ‰í„°ë¦¬ ìƒì„±
  - mkdir -p /opt/chat-service
  - mkdir -p /opt/chat-service/webroot
  - chown -R ubuntu:ubuntu /opt/chat-service

  # ì¸ìŠ¤í„´ìŠ¤ OS ë°©í™”ë²½ì— 3000/tcp í—ˆìš© ë° ì˜êµ¬ ì €ì¥ (ìµœì†Œ ì¶”ê°€)
  - |
    set -e
    iptables -C INPUT -p tcp --dport 3000 -j ACCEPT || iptables -I INPUT -p tcp --dport 3000 -j ACCEPT
    if ! command -v netfilter-persistent >/dev/null 2>&1; then
      apt-get update -y
      DEBIAN_FRONTEND=noninteractive apt-get install -y iptables-persistent netfilter-persistent
    fi
    netfilter-persistent save

  # Let's Encrypt ì¸ì¦ì„œ ë°œê¸‰ (ë°±ê·¸ë¼ìš´ë“œë¡œ ì‹¤í–‰, 5ë¶„ í›„)
  - |
    set -e
    echo "â° Let's Encrypt ì„¤ì •ì„ 5ë¶„ í›„ì— ë°±ê·¸ë¼ìš´ë“œë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤..."
    (sleep 300 && /usr/local/sbin/setup-letsencrypt.sh > /var/log/letsencrypt-setup.log 2>&1) &
    echo "ğŸ“‹ ì§„í–‰ ìƒí™©ì€ 'tail -f /var/log/letsencrypt-setup.log' ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."

# 5. ìµœì¢… ë©”ì‹œì§€
final_message: |
  ğŸ‰ Cloud-init setup completed for ${project_name} ${environment} server.

  âœ… ì„¤ì¹˜ëœ êµ¬ì„± ìš”ì†Œ:
  â–¸ Docker & Docker Compose v2 ì„¤ì¹˜ ì™„ë£Œ
  â–¸ OCI CLI ì„¤ì¹˜ ì™„ë£Œ (Container Registry ì¸ì¦ìš©)
  â–¸ 2 GiB ìŠ¤ì™‘ íŒŒì¼ í™œì„±í™”
  â–¸ ì¶”ê°€ ë¸”ë¡ ë³¼ë¥¨ /data ë§ˆìš´íŠ¸
  â–¸ ê¸°ë³¸ ë””ë ‰í„°ë¦¬: /opt/chat-service

  ğŸš€ ë°°í¬ ì ˆì°¨:
  1) Container Registry ë¡œê·¸ì¸:
     sudo -u ubuntu /home/ubuntu/docker-login.sh ap-chuncheon-1 <tenancy-namespace> <username> <auth-token>
  
  2) ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬:
     cd /opt/chat-service
     # docker-compose.yml íŒŒì¼ ì¤€ë¹„ í›„
     docker compose up -d
  
  3) í—¬ìŠ¤ì²´í¬:
     curl http://localhost:3000/healthz
  
  ğŸ”’ Let's Encrypt ì¸ì¦ì„œ:
  â–¸ ì¸ìŠ¤í„´ìŠ¤ ì‹œì‘ 5ë¶„ í›„ ìë™ ë°œê¸‰ ì‹œì‘
  â–¸ ì§„í–‰ ìƒí™© í™•ì¸: tail -f /var/log/letsencrypt-setup.log
  â–¸ ì¸ì¦ì„œ ìœ„ì¹˜: /opt/letsencrypt/
  â–¸ ìë™ ê°±ì‹ : ë§¤ì£¼ ì¼ìš”ì¼ ì˜¤ì „ 2ì‹œ
  
  ğŸ“ ì£¼ìš” ë””ë ‰í„°ë¦¬:
  â–¸ /opt/chat-service - ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ
  â–¸ /data - ì˜êµ¬ ë°ì´í„° ì €ì¥ì†Œ (50GB ë¸”ë¡ ë³¼ë¥¨)
  â–¸ /opt/letsencrypt - Let's Encrypt ì¸ì¦ì„œ
  â–¸ /home/ubuntu/docker-login.sh - Container Registry ë¡œê·¸ì¸ ìŠ¤í¬ë¦½íŠ¸
